// Copyright (c) 2012-2013 Qualcomm Technologies, Inc.  All Rights Reserved. Qualcomm Technologies Proprietary and Confidential.
'use strict';const Cc=Components.classes;const Ci=Components.interfaces;const Cu=Components.utils;Cu.import('resource://gre/modules/XPCOMUtils.jsm');Cu.import('resource://gre/modules/ctypes.jsm');const TAG='QLOC: MozSettingShim: ';const kMozSettingsChanged='mozsettings-changed';const kGeolocationSetting='geolocation.enabled';const kWiFiSetting='wifi.enabled';const kRadioDisabledSetting='ril.radio.disabled';const kSuplApnSetting='ril.supl.apn';const kDataApnSetting='ril.data.apn';const kRilDataDefaultServiceId='ril.data.defaultServiceId';const kBatteryInformation='gonkhal-battery-notifier';const kSettingSuplVerificationChoice='supl.verification.choice';let curChargingStatus=undefined;XPCOMUtils.defineLazyServiceGetter(this,'gConsoleService','@mozilla.org/consoleservice;1','nsIConsoleService');XPCOMUtils.defineLazyServiceGetter(this,'gObsService','@mozilla.org/observer-service;1','nsIObserverService');XPCOMUtils.defineLazyServiceGetter(this,'gSettingsService','@mozilla.org/settingsService;1','nsISettingsService');function QMozSettingsShim(){gConsoleService.logStringMessage(TAG+'Create QMozSettingsShim interface');this.callback=0;}
QMozSettingsShim.prototype={classID:Components.ID('{54dcaec9-7f8e-4878-9292-465424d9f800}'),contractID:'@qti.qualcomm.com/QMozSettingsShim;1',QueryInterface:XPCOMUtils.generateQI([Ci.nsIQMozSettingsShim,Ci.nsIObserver,Ci.nsISettingsServiceCallback]),registerSettingCallback:function nsIQMozSettingsShim_registerSettingCallback(cb){gConsoleService.logStringMessage(TAG+'Register callback: '+cb);this.callback=cb;},unregisterSettingCallback:function nsIQMozSettingsShim_unregisterSettingCallback(){gConsoleService.logStringMessage(TAG+'Remove callback');this.callback=0;},addObserver:function nsIQMozSettingsShim_addObserver(topic){gConsoleService.logStringMessage(TAG+'Add moz-settings observer: '+
topic);gObsService.addObserver(this,topic,false);},removeObserver:function nsIQMozSettingsShim_removeObserver(topic){gConsoleService.logStringMessage(TAG+'Remove moz-settings observer:'+
topic);gObsService.removeObserver(this,topic);},requestSettingValue:function nsIQMozSettingsShim_requestSettingValue(key){gConsoleService.logStringMessage(TAG+'Request setting value:'+key);let lock=gSettingsService.createLock();lock.get(key,this);},observe:function(aSubject,aTopic,aData){if(this.callback){switch(aTopic){case kMozSettingsChanged:{let setting=aSubject;if('wrappedJSObject'in setting){setting=setting.wrappedJSObject;}
switch(setting.key){case kRilDataDefaultServiceId:case kSettingSuplVerificationChoice:this.callback.notifyMozSettingChangeInt(setting.key,setting.value);break;case kGeolocationSetting:case kWiFiSetting:case kRadioDisabledSetting:this.callback.notifyMozSettingChangeBool(setting.key,setting.value);break;}}
break;case kBatteryInformation:{gConsoleService.logStringMessage(TAG+'Got topic change:'+aTopic);let propbag=aSubject.QueryInterface(Ci.nsIPropertyBag2);let chargingStatus=propbag.getPropertyAsBool('charging');if(chargingStatus!=curChargingStatus){curChargingStatus=chargingStatus;this.callback.notifyMozSettingChangeBool('charging',curChargingStatus);}}
break;default:break;}}},handle:function nsISettingsServiceCallback_handle(aName,aResult,aMessage){switch(aName){case kGeolocationSetting:case kWiFiSetting:case kRadioDisabledSetting:this.callback.updateRequestedValueBool(aName,aResult);break;case kSuplApnSetting:case kDataApnSetting:this.callback.updateRequestedValueString(aName,aResult);break;case kRilDataDefaultServiceId:this.callback.updateRequestedValueInt(aName,aResult);break;}},handleError:function nsISettingsServiceCallback_handleError(aErrorMessage){gConsoleService.logStringMessage(TAG+'Error while reading setting:'+aErrorMessage);},classInfo:XPCOMUtils.generateCI({'classID':Components.ID('{54dcaec9-7f8e-4878-9292-465424d9f800}'),'contractID':'@qti.qualcomm.com/QMozSettingsShim;1','interfaces':[Ci.nsIQMozSettingsShim],'flags':Ci.nsIClassInfo.DOM_OBJECT,'classDescription':'QMozSettingsShim class'})};this.NSGetFactory=XPCOMUtils.generateNSGetFactory([QMozSettingsShim]);